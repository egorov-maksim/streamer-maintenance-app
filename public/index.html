<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Streamer Maintenance Tracker</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>

  <!-- Login Page -->
  <div id="login-page" class="login-page">
    <div class="login-container">
      <div class="login-header">
        <div class="login-logo">ğŸŒŠ</div>
        <h1>Streamers Scraping Tracker</h1>
        <p class="login-subtitle">Sign in to access the maintenance dashboard</p>
      </div>
      
      <form id="login-form" class="login-form">
        <div class="form-group">
          <label for="login-username">Username</label>
          <div class="input-wrapper">
            <span class="input-icon">ğŸ‘¤</span>
            <input 
              type="text" 
              id="login-username" 
              name="username" 
              placeholder="Enter your username"
              autocomplete="username"
              required
            >
          </div>
        </div>
        
        <div class="form-group">
          <label for="login-password">Password</label>
          <div class="input-wrapper">
            <span class="input-icon">ğŸ”’</span>
            <input 
              type="password" 
              id="login-password" 
              name="password" 
              placeholder="Enter your password"
              autocomplete="current-password"
              required
            >
            <button type="button" class="password-toggle" id="password-toggle">ğŸ‘ï¸</button>
          </div>
        </div>
        
        <div id="login-error" class="login-error"></div>
        
        <button type="submit" class="login-btn" id="login-submit">
          <span class="btn-text">Sign In</span>
          <span class="btn-loader" style="display: none;">â³</span>
        </button>
      </form>
      
      <div class="login-footer">
        <p>Access Levels:</p>
        <div class="access-info">
          <span class="access-badge admin">ğŸ”‘ Administrator</span>
          <span class="access-badge viewer">ğŸ‘ï¸ Viewer</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App Container (hidden until logged in) -->
  <div id="app-container" class="app-container" style="display: none;">
    
    <!-- User Header Bar -->
    <div class="user-header">
      <div class="user-info">
        <span class="user-avatar">ğŸ‘¤</span>
        <span class="user-name" id="user-display-name">User</span>
        <span class="user-role-badge" id="user-role-badge">Viewer</span>
      </div>
      <button class="logout-btn" id="logout-btn">
        <span>ğŸšª</span> Logout
      </button>
    </div>

  <!-- Left Sidebar Navigation -->
  <nav class="sidebar-nav">
    <div class="nav-item active" data-target="heatmap-section">
      <div class="nav-icon">ğŸ—ºï¸</div>
      <div class="nav-label">Heatmap</div>
    </div>
    <div class="nav-item" data-target="log-section">
      <div class="nav-icon">ğŸ“œ</div>
      <div class="nav-label">Log</div>
    </div>
    <div class="nav-item" data-target="stats-section">
      <div class="nav-icon">ğŸ“Š</div>
      <div class="nav-label">Stats</div>
    </div>
  </nav>

  <div class="main-wrapper">
    <header>
      <h1>ğŸŒŠ Streamers Scraping Tracker</h1>
      <div class="subheader">Track cleaning events across all streamers</div>
    </header>

    <main>

           <!-- Unified Project & Streamer Configuration -->
           <section class="card" id="project-config-section">
            <h2 class="card-title project-header" style="cursor: pointer; user-select: none;">
              <span>ğŸ“‹ Project & Streamer Configuration</span>
              <span class="collapse-icon" id="project-collapse-icon">â–¼</span>
            </h2>
            <div id="project-content" class="config-collapsible">
              
              <!-- Active Project Display -->
              <div class="active-project-banner" id="active-project-banner">
                <div class="active-project-info">
                  <span class="active-project-label">Active Project:</span>
                  <span class="active-project-name" id="active-project-name">No project selected</span>
                  <span class="active-project-vessel" id="active-project-vessel"></span>
                </div>
                <button class="btn btn-outline btn-sm" id="btn-clear-project" style="display: none;">Clear</button>
              </div>
              
              <!-- Project Selector -->
              <div class="grid grid-2" style="margin-top: 16px;">
                <label>Select Project
                  <select id="project-selector">
                    <option value="">-- All Projects (No Filter) --</option>
                  </select>
                </label>
                <div class="actions" style="align-self: flex-end;">
                  <button class="btn btn-primary" id="btn-activate-project">ğŸ¯ Set as Active</button>
                </div>
              </div>
              
              <!-- Streamer Configuration (tied to active project) -->
              <div class="streamer-config-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">âš™ï¸ Streamer Configuration <span id="config-project-label" style="color: #6b7280; font-weight: 400;"></span></h3>
                <div class="grid grid-3">
                  <label>Number of Streamers <input type="number" id="cfg-numCables" min="1" value="12"></label>
                  <label>Active Sections per Streamer <input type="number" id="cfg-sectionsPerCable" min="1" value="107"></label>
                  <label>Section Length (m) <input type="number" id="cfg-sectionLength" min="1" value="75"></label>
                  <label>eBird Frequency (every N sections) <input type="number" id="cfg-moduleFrequency" min="1" value="4"></label>
                  <label>Channels per Section <input type="number" id="cfg-channelsPerSection" min="1" value="6"></label>
                  <label>Tail Configuration
                    <select id="cfg-useRopeForTail">
                      <option value="true">Use Rope (no extra sections)</option>
                      <option value="false">Add 5 Tail Sections</option>
                    </select>
                  </label>
                </div>
                <div class="actions" style="margin-top: 12px;">
                  <button class="btn btn-primary admin-only" id="btn-save-config">ğŸ’¾ Save Configuration</button>
                  <span id="config-status" class="status"></span>
                </div>
                <p style="font-size: 13px; color: #6b7280; margin-top: 8px;">
                  <strong>Note:</strong> Configuration is saved per project. eBird appear after 1st section, then every N sections.
                </p>
              </div>
              
              <!-- Create New Project -->
              <div class="project-create-section admin-only" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">â• Create New Project</h3>
                <div class="grid grid-3">
                  <label>Project Number <input type="text" id="new-project-number" placeholder="e.g., PRJ-2026-001"></label>
                  <label>Project Name <input type="text" id="new-project-name" placeholder="e.g., North Sea Survey"></label>
                  <label>Vessel Tag <input type="text" id="new-project-vessel" value="TTN" placeholder="e.g., TTN"></label>
                </div>
                <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">
                  New projects inherit the current streamer configuration. You can modify it after creation.
                </p>
                <div class="actions" style="margin-top: 12px;">
                  <button class="btn btn-secondary" id="btn-create-project">â• Create Project</button>
                  <span id="project-status" class="status"></span>
                </div>
              </div>
              
              <!-- Project List -->
              <div class="project-list-section" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ“ All Projects</h3>
                <div id="project-list" class="project-list"></div>
              </div>
              
              <!-- Database Backup & Restore (Admin Only) -->
              <div class="backup-section admin-only" style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e5e7eb;">
                <h3 style="font-size: 14px; font-weight: 600; margin-bottom: 12px;">ğŸ’¾ Database Backup & Restore</h3>
                <p style="font-size: 13px; color: #6b7280; margin-bottom: 12px;">
                  Database is automatically backed up every 12 hours. You can create manual backups or restore from previous backups.
                </p>
                <div class="actions" style="margin-bottom: 12px;">
                  <button class="btn btn-secondary" id="btn-create-backup">ğŸ’¾ Create Backup Now</button>
                  <button class="btn btn-outline" id="btn-refresh-backups">ğŸ”„ Refresh List</button>
                  <span id="backup-status" class="status"></span>
                </div>
                <div id="backup-list" class="backup-list"></div>
              </div>
              
            </div>
          </section>

      <!-- Alerts -->
      <div id="alerts-container"></div>

      <!-- Method Selection -->
      <section class="card">
        <h2 class="card-title">ğŸ§¹ Cleaning Method Selection</h2>
        <p style="font-size: 14px; margin-bottom: 12px">Select a cleaning method to use</p>
        <div class="method-tiles">
          <div class="method-tile active" data-method="rope">
            <div style="font-size: 32px">ğŸª¢</div>
            <div class="method-name">Rope</div>
          </div>
          <div class="method-tile" data-method="scraper">
            <div style="font-size: 32px">ğŸ› ï¸</div>
            <div class="method-name">Scraper</div>
          </div>
          <div class="method-tile" data-method="scraper-rope">
            <div style="font-size: 32px">ğŸª¢ğŸ› ï¸</div>
            <div class="method-name">Scraper&Rope</div>
          </div>
          <div class="method-tile" data-method="scue">
            <div style="font-size: 32px">âš™ï¸</div>
            <div class="method-name">SCUE</div>
          </div>
          <div class="method-tile" data-method="knife">
            <div style="font-size: 32px">ğŸ”ª</div>
            <div class="method-name">Knife</div>
          </div>
        </div>
        <p style="margin-top: 12px; font-size: 13px"><strong>How to mark sections:</strong> Click and drag across active section cells to mark them as cleaned.</p>
      </section>

      <!-- Heat Map -->
      <section id="heatmap-section" class="card streamers-card">
        <h2 class="card-title">ğŸ—ºï¸ Streamers Detail View</h2>

        <!-- Legend -->
        <div class="legend" style="margin-bottom: 16px">
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-fresh)"></span> 0 day (fresh)</div>
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-4plus)"></span> 4+ days</div>
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-7plus)"></span> 7+ days</div>
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-10plus)"></span> 10â€“13 days</div>
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-14plus)"></span> 14+ days (needs cleaning)</div>
          <div class="badge"><span class="legend-swatch" style="background: var(--heat-never)"></span> Never cleaned</div>
          <div class="badge"><span class="legend-swatch" style="background: #fbbf24; border: 2px solid #f59e0b;"></span> EB Module</div>
        </div>

        <div id="heatmap-container" class="hm-grid-container"></div>
      </section>

      <!-- History Log -->
      <section id="log-section" class="card">
        <h2 class="card-title">ğŸ“œ Cleaning History Log</h2>
        <div class="actions" style="margin-bottom: 12px">
          <button class="btn btn-secondary" id="btn-export-csv">ğŸ“¥ Export CSV</button>
          <button class="btn btn-secondary" id="btn-import-csv">ğŸ“¤ Import CSV</button>
          <input type="file" id="csv-input" accept=".csv" style="display:none">
          <button class="btn btn-danger" id="btn-clear-all">ğŸ—‘ï¸ Clear All Events</button>
        </div>
        <textarea id="csv-output" class="csv-output" readonly></textarea>
        <div class="table-wrapper">
          <table id="events-table">
            <thead>
              <tr>
                <th class="sortable" data-sort="date">Date & Time <span class="sort-icon">â†•</span></th>
                <th class="sortable" data-sort="project">Project <span class="sort-icon">â†•</span></th>
                <th>Vessel</th>
                <th class="sortable" data-sort="streamer">Streamer <span class="sort-icon">â†•</span></th>
                <th class="sortable" data-sort="section">Section Range <span class="sort-icon">â†•</span></th>
                <th>EB Range</th>
                <th class="sortable" data-sort="distance">Length (m) <span class="sort-icon">â†•</span></th>
                <th class="sortable" data-sort="method">Method <span class="sort-icon">â†•</span></th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="log-body"></tbody>
          </table>
        </div>
      </section>

      <!-- Manual Entry -->
      <section class="card">
        <h2 class="card-title">âœï¸ Manual Entry of Cleaning Event</h2>
        <div class="grid grid-4">
          <label>Streamer Number <input type="number" id="evt-streamer" min="1" max="12" value="1"></label>
          <label>First Section <input type="number" id="evt-start" min="1" max="107" value="1"></label>
          <label>Last Section <input type="number" id="evt-end" min="1" max="107" value="1"></label>
          <label>Cleaning Method
            <select id="evt-method">
              <option value="rope">Rope</option>
              <option value="scraper">Scraper</option>
              <option value="scraper-rope">Scraper&Rope</option>
              <option value="scue">SCUE</option>
              <option value="knife">Knife</option>
            </select>
          </label>
          <label>Date <input type="date" id="evt-date"></label>
          <label>Time <input type="time" id="evt-time"></label>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-add-event">â• Add Event</button>
          <span id="event-status" class="status"></span>
        </div>
      </section>

      <!-- Statistics -->
      <section id="stats-section" class="card">
        <h2 class="card-title">ğŸ“ˆ Statistics & Data Filtering</h2>
        
        <!-- Filter Controls -->
        <div class="grid grid-2 filter-controls">
          <label>Start Date <input type="date" id="filter-start"></label>
          <label>End Date <input type="date" id="filter-end"></label>
        </div>
        <div class="actions">
          <button class="btn btn-primary" id="btn-apply-filter">Apply Filter</button>
          <button class="btn btn-secondary" id="btn-reset-filter">Reset Filter</button>
        </div>
        
        <!-- Streamer Maintenance Overview -->
        <div class="streamer-overview-section">
          <h3 class="section-subtitle">ğŸ“Š Streamer Maintenance Overview</h3>
          <div id="streamer-cards-container" class="streamer-cards"></div>
        </div>
        
        <!-- Statistics KPIs -->
        <div class="kpis">
          <div class="kpi">
            <div class="kpi-title">Coverage</div>
            <div class="kpi-value" id="kpi-coverage">0%</div>
            <div class="kpi-sub" id="kpi-coverage-sub">0 / 0 sections</div>
            <div class="kpi-breakdown" id="kpi-breakdown"></div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Total Distance</div>
            <div class="kpi-value" id="kpi-distance">0.0 km</div>
            <div class="kpi-sub" id="kpi-distance-sub">0 meters cleaned</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Cleaning Events</div>
            <div class="kpi-value" id="kpi-events">0</div>
            <div class="kpi-sub" id="kpi-events-sub">0 log entries</div>
          </div>
          <div class="kpi">
            <div class="kpi-title">Last Cleaning</div>
            <div class="kpi-value" id="kpi-last" style="font-size: 14px">â€”</div>
            <div class="kpi-sub" id="kpi-last-sub">No events</div>
          </div>
        </div>
        
        <div id="method-breakdown" class="method-breakdown"></div>
      </section>

      <div class="actions" style="margin-top: 20px;">
        <button id="generatePdfBtn" class="btn btn-primary">
          ğŸ“„ Generate PDF Report
        </button>
      </div>
      <div id="pdf-status" class="status"></div>

    </main>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmation-modal" class="modal">
    <div id="modal-overlay" class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœ… Confirm Cleaning Event</h3>
        <button class="modal-close" id="btn-modal-close">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="grid grid-2">
          <label>Streamer Number <input type="number" id="modal-streamer" min="1" max="12" value="1"></label>
          <label>Cleaning Method
            <select id="modal-method">
              <option value="rope">ğŸª¢ Rope</option>
              <option value="scraper">ğŸ› ï¸ Scraper</option>
              <option value="scraper-rope">ğŸª¢ğŸ› ï¸ Scraper&Rope</option>
              <option value="scue">âš™ï¸ SCUE</option>
              <option value="knife">ğŸ”ª Knife</option>
            </select>
          </label>
          <label>First Section <input type="number" id="modal-start" min="1" value="1"></label>
          <label>Last Section <input type="number" id="modal-end" min="1" value="1"></label>
        </div>
        <div class="modal-summary">
          <div class="summary-item">
            <span class="summary-label">Range</span>
            <span class="summary-value" id="modal-summary-range">AS01 - AS01</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Channels</span>
            <span class="summary-value" id="modal-summary-channels">Ch 1-6</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">Distance</span>
            <span class="summary-value" id="modal-summary-distance">75 m</span>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-modal-cancel">Cancel</button>
        <button class="btn btn-primary" id="btn-modal-confirm">âœ… Confirm & Save</button>
      </div>
    </div>
  </div>

  <!-- Edit Event Modal -->
  <div id="edit-modal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>âœï¸ Edit Cleaning Event</h3>
        <button class="modal-close" id="btn-edit-close">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="edit-event-id">
        <div class="grid grid-2">
          <label>Streamer Number <input type="number" id="edit-streamer" min="1" max="12" value="1"></label>
          <label>Cleaning Method
            <select id="edit-method">
              <option value="rope">Rope</option>
              <option value="scraper">Scraper</option>
              <option value="scraper-rope">Scraper&Rope</option>
              <option value="scue">SCUE</option>
              <option value="knife">Knife</option>
            </select>
          </label>
          <label>First Section <input type="number" id="edit-start" min="1" value="1"></label>
          <label>Last Section <input type="number" id="edit-end" min="1" value="1"></label>
          <label>Date <input type="date" id="edit-date"></label>
          <label>Time <input type="time" id="edit-time"></label>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="btn-edit-cancel">Cancel</button>
        <button class="btn btn-primary" id="btn-edit-save">ğŸ’¾ Save Changes</button>
      </div>
    </div>
  </div>


</div>

 <!-- Delete Event Modal -->
  <div id="delete-modal" class="modal">
    <div class="modal-overlay"></div>
    <div class="modal-content modal-delete">
      <div class="modal-header modal-header-delete">
        <h3>ğŸ—‘ï¸ Delete Cleaning Event</h3>
        <button class="modal-close" id="btn-delete-close">Ã—</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="delete-event-id">
        
        <div class="delete-warning">
          <div class="warning-icon">âš ï¸</div>
          <div class="warning-text">
            <strong>Warning:</strong> This action cannot be undone. The following cleaning event will be permanently deleted.
          </div>
        </div>

        <div class="event-details">
          <div class="detail-row">
            <span class="detail-label">Streamer Number</span>
            <span class="detail-value" id="delete-streamer-display">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Section Range</span>
            <span class="detail-value" id="delete-range-display">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">EB Range</span>
            <span class="detail-value" id="delete-eb-display">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Distance</span>
            <span class="detail-value" id="delete-distance-display">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Cleaning Method</span>
            <span class="detail-value" id="delete-method-display">-</span>
          </div>
          <div class="detail-row">
            <span class="detail-label">Date & Time</span>
            <span class="detail-value" id="delete-date-display">-</span>
          </div>
        </div>
      </div>
      <div class="modal-footer modal-footer-delete">
        <button class="btn btn-secondary" id="btn-delete-cancel">Cancel</button>
        <button class="btn btn-danger" id="btn-delete-confirm">ğŸ—‘ï¸ Delete Event</button>
      </div>
    </div>
  </div>


  </div> <!-- Close app-container -->

  <!-- Toast Notification Container -->
  <div id="toast-container" class="toast-container"></div>

  <script src="libs/jspdf.umd.min.js"></script>
  <script src="app.js"></script>
  <script src="pdf-generator.js"></script>
</body>
</html>
